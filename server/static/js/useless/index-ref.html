<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>A leaflet Test!</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script  type ="text/javascript" src="http://code.jquery.com/jquery-1.11.1.min.js"></script>

    <script type="text/javascript" src="front_end.js"></script>
</head>
<body>
    <div><p>It is a test code.</p> </div>
    <div id="map">
    <div>

    <script type="text/javascript">

    //Step 1: get data
    function init_data_info(data){
        data_info = data;
    }

    var get_data = new DataManager();
    var data_info = [];
    var counter = 0;

    get_data.getDataFromBackEnd(init_data_info);

    //Step 2: use Leaflet to create map
   var map = L.map('map')
           .setView([22.3375, 114.2630], 3);

    // add an OpenStreetMap tile layer
   L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
       maxZoom: 15,
       attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
               '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
               'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
       id: 'jiayouwyhit.k47o83bm'
   }).addTo(map); //jiayouwyhit.k47o83bm  k3eln9aa

    var marker = L.marker([22.3375, 114.2630]).addTo(map);
    marker.bindPopup("<b>HKUST</b> ")/*.openPopup()*/;

    var popup = L.popup({maxWidth:400, minWidth:50, maxHeight:null });
    function onMapClick(e){
        popup.setLatLng(e.latlng)//e is the event
                .setContent("You clicked the map at " + e.latlng.toString() )
                .openOn(map);
    }
    map.on('click',onMapClick);

    //Step 3: combine D3 with leafLet to visualize info
    function draw()
    {
        //draw image
        var w = 1170, h = 450, diameter = 0;
        var dataset = [];
        var numDataPoints = 300;

        if(data_info && data_info.length > numDataPoints){
            counter++;
            console.log(counter);
            var upLimit = counter * numDataPoints;
            if(upLimit > data_info.length) counter = 1;

            var start = (counter-1)*numDataPoints, end = counter*numDataPoints;
            for(var i = start; i < end; i++ ){
                dataset.push(data_info[i]);
            }
        }

        /* Initialize the SVG layer */
        map._initPathRoot();  //!!! what does this mean??

        var svg = d3.select("#map").select("svg"),
                gp = svg.append("g");

        var myCircle_pre = gp
                .selectAll("circle")
                .data(dataset);
        var myCircle = myCircle_pre
                .enter()
                .append("circle")
                .attr("r", diameter)
                .attr("opacity", 0.8)
                .attr("fill", function(d){
                    if(d.actionMode === 'seeked')        return "#1f77b4";
                    else if(d.actionMode === 'pause')    return "#fdae6b";
                    else if(d.actionMode === 'play')     return "#2ca02c";
                    else if(d.actionMode === 'stalled')   return "#d62728";
                    else if(d.actionMode === 'ratechange')   return "#8c564b";
                    else return "#9467bd";
                });

        map.on("viewreset", update);
        update();

        function update() {
            myCircle.attr("transform", function (d) {
                var latlng = new L.LatLng(d.latLng.latitude, d.latLng.longitude);
                return "translate(" +
                        map.latLngToLayerPoint(latlng).x + "," +
                        map.latLngToLayerPoint(latlng).y + ")";
            });
        }

        myCircle.transition()
                .duration(500)
                .attr("r", 10)
                .style("opacity", 0.0)
                .delay(function(d,i){ return i*2;});

    /*    d3.selectAll("circle") //another way to remove circles
                .data([])
                .exit().transition().delay(600).remove();*/

        myCircle_pre.exit();
        myCircle_pre.transition().delay(1100).remove();

        dataset = null;
        setTimeout(draw,600);
    }
   draw();

  </script>

</body>
</html>